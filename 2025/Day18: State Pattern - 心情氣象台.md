# Day 18: State Pattern - å¿ƒæƒ…æ°£è±¡å°

## è€é—†èªžéŒ„ ðŸ’¬

> "æˆ‘å¿ƒæƒ…å¥½çš„æ™‚å€™ä»€éº¼éƒ½å¥½èªªï¼Œå¿ƒæƒ…ä¸å¥½æ™‚å…è«‡ï¼ä½ å€‘è¦å­¸æœƒçœ‹æˆ‘çš„è‡‰è‰²è¡Œäº‹ï¼Œç³»çµ±ä¹Ÿè¦æ‡‚å¾—å¯Ÿè¨€è§€è‰²ï¼"

## ç½é›£ç¾å ´ ðŸ”¥

é€±å››ä¸‹åˆ 2 é»žï¼Œè¾¦å…¬å®¤è£¡ç€°æ¼«è‘—ç·Šå¼µçš„æ°£æ°›ã€‚è€é—†å‰›å¾žä¸€å€‹ä¸é †åˆ©çš„å®¢æˆ¶æœƒè­°å›žä¾†ï¼Œè‡‰è‰²é™°æ²‰å¦‚çƒé›²ã€‚

ã€Œç‚ºä»€éº¼å®¢æˆ¶æŠ•è¨´è™•ç†ç³»çµ±é‚„æ²’åšå¥½ï¼Ÿã€è€é—†é‡é‡åœ°æ”¾ä¸‹åŒ…åŒ…ã€‚

ç”¢å“ç¶“ç†å°ç¾Žæˆ°æˆ°å…¢å…¢åœ°èªªï¼šã€Œæˆ‘å€‘æŒ‰ç…§æ‚¨ä¸Šé€±çš„æŒ‡ç¤º...ã€

ã€Œä¸Šé€±ï¼Ÿã€è€é—†çœ‰é ­ç·Šçšºï¼Œã€Œä¸Šé€±æˆ‘å¿ƒæƒ…ä¸å¥½ï¼Œèªªçš„è©±ä¸ç®—æ•¸ï¼ã€

ç³»çµ±åˆ†æžå¸«å°èŽ‰å›°æƒ‘åœ°å•ï¼šã€Œé‚£...æˆ‘å€‘è¦æ€Žéº¼çŸ¥é“ä»€éº¼æ™‚å€™æ‚¨çš„è©±ç®—æ•¸ï¼Ÿã€

è€é—†åœé “äº†ä¸€ä¸‹ï¼Œçªç„¶çœ¼ç¥žç™¼äº®ï¼šã€Œå°å•Šï¼é€™å°±æ˜¯å•é¡Œï¼ä½ å€‘è¦å»ºç«‹ä¸€å€‹ã€Žè€é—†å¿ƒæƒ…é æ¸¬ç³»çµ±ã€ï¼ã€

ä»–é–‹å§‹åœ¨ç™½æ¿ä¸Šç•«åœ–ï¼šã€Œæˆ‘çš„å¿ƒæƒ…æœ‰ä¸åŒç‹€æ…‹ï¼šé–‹å¿ƒã€ç”Ÿæ°£ã€ç„¦æ…®ã€èˆˆå¥®...æ¯ç¨®å¿ƒæƒ…ä¸‹ï¼Œæˆ‘å°åŒä¸€ä»¶äº‹çš„åæ‡‰å®Œå…¨ä¸åŒï¼ã€

ã€Œæ¯”å¦‚èªª...ã€è€é—†æŒ‡è‘—åœ–ï¼Œã€Œé–‹å¿ƒæ™‚ï¼Œä½ å€‘æåŠ è–ªæˆ‘æœƒèªªã€Žå¥½å•Šå¥½å•Šã€ï¼›ç”Ÿæ°£æ™‚ï¼ŒåŒæ¨£çš„è«‹æ±‚æˆ‘æœƒèªªã€Žæƒ³éƒ½åˆ¥æƒ³ã€ï¼›ç„¦æ…®æ™‚ï¼Œæˆ‘æœƒèªªã€Žç¾åœ¨åˆ¥ç…©æˆ‘ã€ï¼›èˆˆå¥®æ™‚ï¼Œæˆ‘ç”šè‡³æœƒèªªã€Žä¸å¦‚ç›´æŽ¥å‡è·ã€ï¼ã€

å‰ç«¯å·¥ç¨‹å¸«å°æŽå¼±å¼±åœ°å•ï¼šã€Œé‚£ç³»çµ±è¦æ€Žéº¼åˆ¤æ–·æ‚¨çš„å¿ƒæƒ…ï¼Ÿã€

ã€Œæ ¹æ“šæŒ‡æ¨™å•Šï¼ã€è€é—†è¶Šèªªè¶Šèˆˆå¥®ï¼Œã€Œè‚¡åƒ¹ã€ç‡Ÿæ”¶ã€å®¢æˆ¶æ»¿æ„åº¦ã€ç«¶çˆ­å°æ‰‹å‹•æ…‹...é€™äº›éƒ½æœƒå½±éŸ¿æˆ‘çš„å¿ƒæƒ…ï¼ç³»çµ±è¦èƒ½ã€Žæ™ºèƒ½åˆ‡æ›ã€æˆ‘çš„æ±ºç­–æ¨¡å¼ï¼ã€

å¾Œç«¯å·¥ç¨‹å¸«é˜¿å¼·æå‡ºç–‘å•ï¼šã€Œä½†æ˜¯æ¯ç¨®å¿ƒæƒ…çš„è™•ç†é‚è¼¯éƒ½ä¸ä¸€æ¨£...ã€

ã€Œé€™å°±æ˜¯é‡é»žï¼ã€è€é—†æ‹æ‰‹ï¼Œã€ŒåŒæ¨£æ˜¯ã€Žå“¡å·¥è«‹å‡ã€é€™ä»¶äº‹ï¼šé–‹å¿ƒæ™‚æˆ‘æœƒæ‰¹å‡†ä¸¦èªªã€Žå¥½å¥½ä¼‘æ¯ã€ï¼›ç”Ÿæ°£æ™‚æˆ‘æœƒæ‹’çµ•ä¸¦èªªã€Žç¾åœ¨å¤ªå¿™ã€ï¼›ç„¦æ…®æ™‚æˆ‘æœƒå»¶å¾Œä¸¦èªªã€Žä¸‹å€‹æœˆå†èªªã€ï¼›èˆˆå¥®æ™‚æˆ‘æœƒæ‰¹å‡†ä¸¦èªªã€Žå¤šä¼‘å¹¾å¤©æ²’é—œä¿‚ã€ï¼ã€

è²¡å‹™ä¸»ç®¡è€è¶™è©¦åœ–ç†è§£ï¼šã€Œæ‰€ä»¥æ‚¨å¸Œæœ›ç³»çµ±èƒ½...æ ¹æ“šæ‚¨çš„å¿ƒæƒ…ç‹€æ…‹èª¿æ•´åæ‡‰ï¼Ÿã€

ã€Œå°ï¼ã€è€é—†ç¸½çµï¼Œã€Œç³»çµ±è¦åƒã€Žå¿ƒæƒ…æ°£è±¡å°ã€ä¸€æ¨£ï¼èƒ½é æ¸¬æˆ‘çš„å¿ƒæƒ…è®ŠåŒ–ï¼Œä¸¦æ ¹æ“šä¸åŒå¿ƒæƒ…æä¾›ä¸åŒçš„æ±ºç­–å»ºè­°ï¼è€Œä¸”å¿ƒæƒ…è½‰æ›è¦å¾ˆè‡ªç„¶ï¼Œä¸èƒ½çªç„¶å¾žé–‹å¿ƒè·³åˆ°ç”Ÿæ°£ï¼ã€

ä½ çªç„¶æ˜Žç™½äº†ï¼Œè€é—†åœ¨æè¿° **State Pattern** - **å…è¨±ç‰©ä»¶åœ¨å…§éƒ¨ç‹€æ…‹æ”¹è®Šæ™‚æ”¹è®Šå®ƒçš„è¡Œç‚ºï¼Œç‰©ä»¶çœ‹èµ·ä¾†å¥½åƒä¿®æ”¹äº†å®ƒçš„é¡žåˆ¥**ï¼

## æ¨¡å¼è§£æž ðŸ§ 

State Patternï¼ˆç‹€æ…‹æ¨¡å¼ï¼‰æ˜¯è¡Œç‚ºåž‹è¨­è¨ˆæ¨¡å¼ä¸­çš„è®Šè‰²é¾ï¼Œå®ƒçš„æ ¸å¿ƒæ€æƒ³æ˜¯ï¼š**ç•¶ä¸€å€‹ç‰©ä»¶çš„å…§éƒ¨ç‹€æ…‹æ”¹è®Šæ™‚ï¼Œå…è¨±æ”¹è®Šå…¶è¡Œç‚ºï¼Œé€™å€‹ç‰©ä»¶çœ‹èµ·ä¾†åƒæ˜¯æ”¹è®Šäº†å…¶é¡žåˆ¥**ã€‚

åœ¨æˆ‘å€‘çš„å¿ƒæƒ…æ°£è±¡å°ç½é›£ä¸­ï¼Œè€é—†çš„å¿ƒæƒ…ç®¡ç†éœ€æ±‚å®Œç¾Žåœ°å±•ç¾äº† State Pattern çš„æœ¬è³ªï¼š

1. **ç‹€æ…‹å°è£**ï¼šæ¯ç¨®å¿ƒæƒ…éƒ½æœ‰ç¨ç«‹çš„è¡Œç‚ºé‚è¼¯
2. **ç‹€æ…‹è½‰æ›**ï¼šå¿ƒæƒ…æœƒæ ¹æ“šå¤–éƒ¨å› ç´ è‡ªç„¶åˆ‡æ›
3. **è¡Œç‚ºè®ŠåŒ–**ï¼šåŒä¸€æ“ä½œåœ¨ä¸åŒç‹€æ…‹ä¸‹æœ‰ä¸åŒåæ‡‰
4. **é€æ˜Žåˆ‡æ›**ï¼šå¤–éƒ¨ç„¡éœ€çŸ¥é“ç•¶å‰æ˜¯å“ªç¨®ç‹€æ…‹

State Pattern çš„æ ¸å¿ƒçµ„ä»¶ï¼š

- **Context**ï¼šä¸Šä¸‹æ–‡ï¼Œç¶­è­·ä¸€å€‹ç‹€æ…‹å¯¦ä¾‹ä¸¦å®šç¾©å®¢æˆ¶ç«¯ä»‹é¢
- **State**ï¼šæŠ½è±¡ç‹€æ…‹ï¼Œå®šç¾©ä¸€å€‹ä»‹é¢ä»¥å°è£ç‰¹å®šç‹€æ…‹çš„è¡Œç‚º
- **ConcreteState**ï¼šå…·é«”ç‹€æ…‹ï¼Œæ¯å€‹å­é¡žåˆ¥å¯¦ä½œä¸€å€‹èˆ‡Contextçš„ç‹€æ…‹ç›¸é—œçš„è¡Œç‚º

é©ç”¨æƒ…å¢ƒï¼š

- **ç‹€æ…‹æ©Ÿå¯¦ä½œ**ï¼šæœ‰é™ç‹€æ…‹æ©Ÿçš„ç¨‹å¼å¯¦ç¾
- **æ¢ä»¶è¡Œç‚º**ï¼šç‰©ä»¶è¡Œç‚ºä¾è³´æ–¼ç‹€æ…‹çš„å ´æ™¯
- **ç‹€æ…‹è½‰æ›**ï¼šè¤‡é›œçš„ç‹€æ…‹è½‰æ›é‚è¼¯
- **å·¥ä½œæµç¨‹**ï¼šæ¥­å‹™æµç¨‹ä¸­çš„ç‹€æ…‹ç®¡ç†

## ç¨‹å¼ç¢¼ç¯„ä¾‹ ðŸ’»

è®“æˆ‘å€‘å¯¦ä½œä¸€å€‹ã€Œè€é—†å¿ƒæƒ…ç®¡ç†ç³»çµ±ã€ï¼Œå±•ç¤º State Pattern çš„æ ¸å¿ƒæ¦‚å¿µï¼š

```ts
// æŠ½è±¡ç‹€æ…‹
abstract class BossState {
  abstract handleRequest(request: string): string;
  abstract getStateName(): string;
}

// ä¸Šä¸‹æ–‡ï¼šè€é—†å¿ƒæƒ…ç®¡ç†ç³»çµ±
class BossContext {
  private currentState: BossState = new NormalState();

  setState(state: BossState): void {
    console.log(`ðŸ”„ å¿ƒæƒ…è½‰æ›: ${this.currentState.getStateName()} â†’ ${state.getStateName()}`);
    this.currentState = state;
  }

  processRequest(request: string): string {
    console.log(`ðŸ˜Š ç•¶å‰å¿ƒæƒ…: ${this.currentState.getStateName()}`);
    return this.currentState.handleRequest(request);
  }

  // æ ¹æ“šæ¥­å‹™æŒ‡æ¨™èª¿æ•´å¿ƒæƒ…
  updateMood(stockPrice: number, satisfaction: number): void {
    if (stockPrice > 120 && satisfaction > 80) {
      this.setState(new HappyState());
    } else if (stockPrice < 80 || satisfaction < 60) {
      this.setState(new AngryState());
    } else {
      this.setState(new NormalState());
    }
  }
}

// å…·é«”ç‹€æ…‹ï¼šæ­£å¸¸å¿ƒæƒ…
class NormalState extends BossState {
  handleRequest(request: string): string {
    if (request.includes("è«‹å‡")) return "å¥½çš„ï¼Œè¨˜å¾—å¥½å¥½ä¼‘æ¯";
    if (request.includes("åŠ è–ª")) return "æˆ‘å€‘ä¾†è¨Žè«–ä¸€ä¸‹å…·é«”æ•¸å­—";
    return "è½èµ·ä¾†é‚„ä¸éŒ¯ï¼Œç¹¼çºŒåŠªåŠ›";
  }

  getStateName(): string {
    return "ðŸ˜ æ­£å¸¸";
  }
}

// å…·é«”ç‹€æ…‹ï¼šé–‹å¿ƒå¿ƒæƒ…
class HappyState extends BossState {
  handleRequest(request: string): string {
    if (request.includes("è«‹å‡")) return "ç•¶ç„¶å¯ä»¥ï¼å¤šä¼‘æ¯å¹¾å¤©éƒ½æ²’å•é¡Œï¼";
    if (request.includes("åŠ è–ª")) return "å¥½å•Šå¥½å•Šï¼ä½ å€‘éƒ½å¾ˆæ£’ï¼";
    return "å¤ªæ£’äº†ï¼æˆ‘ä»Šå¤©å¿ƒæƒ…ç‰¹åˆ¥å¥½ï¼";
  }

  getStateName(): string {
    return "ðŸ˜Š é–‹å¿ƒ";
  }
}

// å…·é«”ç‹€æ…‹ï¼šç”Ÿæ°£å¿ƒæƒ…
class AngryState extends BossState {
  handleRequest(request: string): string {
    if (request.includes("è«‹å‡")) return "ç¾åœ¨é€™éº¼å¿™é‚„æƒ³è«‹å‡ï¼Ÿæƒ³éƒ½åˆ¥æƒ³ï¼";
    if (request.includes("åŠ è–ª")) return "æ¥­ç¸¾éƒ½é€™æ¨£äº†é‚„æƒ³åŠ è–ªï¼Ÿ";
    return "æˆ‘ç¾åœ¨æ²’å¿ƒæƒ…è™•ç†é€™å€‹ï¼";
  }

  getStateName(): string {
    return "ðŸ˜  ç”Ÿæ°£";
  }
}

// ä½¿ç”¨ç¯„ä¾‹
const boss = new BossContext();

// æ¸¬è©¦æ­£å¸¸ç‹€æ…‹
console.log("=== æ­£å¸¸ç‹€æ…‹ ===");
console.log(boss.processRequest("æˆ‘æƒ³è«‹å‡"));
console.log(boss.processRequest("å¸Œæœ›èƒ½åŠ è–ª"));

// æ¥­ç¸¾å¥½è½‰ï¼Œè€é—†é–‹å¿ƒ
console.log("\n=== æ¥­ç¸¾å¤§å¥½ï¼ ===");
boss.updateMood(130, 85);
console.log(boss.processRequest("æˆ‘æƒ³è«‹å‡"));
console.log(boss.processRequest("å¸Œæœ›èƒ½åŠ è–ª"));

// æ¥­ç¸¾ä¸‹æ»‘ï¼Œè€é—†ç”Ÿæ°£
console.log("\n=== æ¥­ç¸¾ä¸ä½³... ===");
boss.updateMood(70, 50);
console.log(boss.processRequest("æˆ‘æƒ³è«‹å‡"));
console.log(boss.processRequest("å¸Œæœ›èƒ½åŠ è–ª"));
```

## ç”Ÿå­˜æŠ€å·§ ðŸ›¡ï¸

1. **State è¨­è¨ˆåŽŸå‰‡**ï¼š

   - **ç‹€æ…‹å°è£**ï¼šæ¯å€‹ç‹€æ…‹é¡žåˆ¥å°è£ç‰¹å®šç‹€æ…‹çš„è¡Œç‚º
   - **è½‰æ›é‚è¼¯**ï¼šç‹€æ…‹è½‰æ›é‚è¼¯å¯åœ¨ç‹€æ…‹å…§éƒ¨æˆ–ä¸Šä¸‹æ–‡ä¸­
   - **ä»‹é¢ä¸€è‡´**ï¼šæ‰€æœ‰ç‹€æ…‹é¡žåˆ¥å¯¦ä½œç›¸åŒä»‹é¢
   - **å–®ä¸€è·è²¬**ï¼šæ¯å€‹ç‹€æ…‹åªè™•ç†ç‰¹å®šè¡Œç‚º

2. **èˆ‡è€é—†æºé€šç­–ç•¥**ï¼š

   - **æƒ…ç·’æ™ºå•†**ï¼šå±•ç¤ºç³»çµ±èƒ½ç†è§£æƒ…å¢ƒè®ŠåŒ–
   - **é©æ‡‰èƒ½åŠ›**ï¼šèªªæ˜Žå¦‚ä½•æ ¹æ“šæƒ…æ³èª¿æ•´åæ‡‰
   - **é æ¸¬åŠŸèƒ½**ï¼šå¼·èª¿èƒ½é æ¸¬ç‹€æ…‹è®ŠåŒ–è¶¨å‹¢
   - **ä¸€è‡´é«”é©—**ï¼šä¿è­‰ç”¨æˆ¶é«”é©—çš„é€£çºŒæ€§

3. **æŠ€è¡“å¯¦ä½œè¦é»ž**ï¼š

   - **ç‹€æ…‹æ©Ÿè¨­è¨ˆ**ï¼šæ˜Žç¢ºå®šç¾©ç‹€æ…‹è½‰æ›åœ–
   - **è¨˜æ†¶é«”ç®¡ç†**ï¼šè€ƒæ…®ç‹€æ…‹ç‰©ä»¶çš„ç”Ÿå‘½é€±æœŸ
   - **åŸ·è¡Œç·’å®‰å…¨**ï¼šå¤šåŸ·è¡Œç·’ç’°å¢ƒä¸‹çš„ç‹€æ…‹ä¸€è‡´æ€§
   - **ç‹€æ…‹æŒä¹…åŒ–**ï¼šéœ€è¦æ™‚ä¿å­˜å’Œæ¢å¾©ç‹€æ…‹

4. **æž¶æ§‹æ±ºç­–å»ºè­°**ï¼š
   - **ç‹€æ…‹æ•¸é‡**ï¼šé¿å…éŽå¤šç‹€æ…‹å°Žè‡´è¤‡é›œæ€§çˆ†ç‚¸
   - **è½‰æ›è§¸ç™¼**ï¼šè¨­è¨ˆæ¸…æ™°çš„ç‹€æ…‹è½‰æ›è§¸ç™¼æ©Ÿåˆ¶
   - **éŒ¯èª¤è™•ç†**ï¼šè™•ç†ç„¡æ•ˆç‹€æ…‹è½‰æ›çš„æƒ…æ³
   - **ç›£æŽ§æ—¥èªŒ**ï¼šè¨˜éŒ„ç‹€æ…‹è½‰æ›æ­·å²ä»¥ä¾¿é™¤éŒ¯

## æ˜Žæ—¥é å‘Š ðŸ”®

æ˜Žå¤©æˆ‘å€‘å°‡æŽ¢è¨Ž **Template Method Pattern - æµç¨‹æŽ§åˆ¶ç‹‚**ï¼Œå­¸ç¿’å¦‚ä½•æ‡‰å°è€é—†çš„ç¨‹åºåŒ–æ€ç¶­ï¼šã€Œæµç¨‹æ˜¯å›ºå®šçš„ï¼Œä½†ç´°ç¯€ä½ å€‘å„éƒ¨é–€è‡ªå·±æ±ºå®šï¼ã€

æº–å‚™è¿ŽæŽ¥ç®—æ³•æ¡†æž¶çš„æŒ‘æˆ°ï¼ ðŸ“‹
